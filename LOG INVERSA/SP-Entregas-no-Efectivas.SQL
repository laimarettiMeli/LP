CREATE OR REPLACE PROCEDURE `meli-bi-data.SHIPPING_BI.SP_OPS_ENTREGAS_NO_EFECTIVAS`(IN P_BEGIN_DATE DATE, IN P_END_DATE DATE)
BEGIN


  CREATE TEMP TABLE TMP_STAGE_SHIPMENTS_NE
  CLUSTER BY SHP_STATUS_ID
  AS (
      WITH SUBQ_1 AS (
      SELECT 
          CAST(SHIP.SHP_SHIPMENT_ID AS NUMERIC) AS SHP_SHIPMENT_ID,
          SHIP.SIT_SITE_ID,
          TMS.TMS_TR_LOGISTIC_CENTER_ID AS FACILITY_ID,        
          SHIP.SHP_PICKING_TYPE_ID,
          SHIP.SHP_STATUS_ID,
          SHIP.SHP_SUBSTATUS_ID,
          TMS.TMS_TR_STATUS,
          TMS.TMS_HUB_STATUS_ID,
          SHIPPING_BI.FN_API_TIMEZONE(SHIP.SIT_SITE_ID, SHIP.SHP_DATETIME_SHIPPED_ID) AS SHIPPED_DATETIME,
          SHIPPING_BI.FN_API_TIMEZONE(SHIP.SIT_SITE_ID, SHIP.SHP_DATETIME_DELIVERED_ID) AS DELIVERED_DATETIME,
          SHIPPING_BI.FN_API_TIMEZONE(SHIP.SIT_SITE_ID, SHIP.SHP_DATETIME_NOT_DELIVERED) AS  NOT_DELIVERED_DATETIME,
          SHIPPING_BI.FN_API_TIMEZONE(SHIP.SIT_SITE_ID, SHIP.SHP_DATETIME_CANCELLED_ID) AS CANCELLED_DATETIME,
          SHIPPING_BI.FN_API_TIMEZONE(SHIP.SIT_SITE_ID, SHIP.SHP_DATE_RETURNED) AS SHP_RETURNED_DATETIME,
          SHP_ORDER_COST_USD, --SHIP.SHP_ORDER_COST_USD,
          SER.SHP_CARRIER_ID_AJUS AS LAST_MILE_CARRIER_NAME,
          TMS.SHP_INB_CARRIER_NAME AS FIRST_MILE_CARRIER_NAME
      FROM WHOWNER.BT_SHP_SHIPMENTS AS SHIP
        LEFT JOIN WHOWNER.BT_TMS_TRACKING AS TMS 
          ON SHIP.SHP_SHIPMENT_ID = TMS.SHP_SHIPMENT_ID
        JOIN WHOWNER.LK_SHP_SHIPPING_SERVICES AS SER 
         ON SHIP.SHP_SERVICE_ID = SER.SHP_SERVICE_ID
      WHERE SHIP.SHP_TYPE ='forward'
          AND  SHIP.SHP_SHIPPING_MODE_ID = 'me2'
          AND  SHIP.SHP_STATUS_ID in('delivered')
          AND  SHIP.SHP_PICKING_TYPE_ID IN('cross_docking','xd_drop_off','fulfillment','drop_off')
          ), SUBQ_2 AS(
        SELECT 
          CAST(SHIP.SHP_SHIPMENT_ID AS NUMERIC) AS SHP_SHIPMENT_ID,
          SHIP.SIT_SITE_ID,
          TMS.TMS_TR_LOGISTIC_CENTER_ID AS FACILITY_ID,        
          SHIP.SHP_PICKING_TYPE_ID,
          SHIP.SHP_STATUS_ID,
          SHIP.SHP_SUBSTATUS_ID,
          TMS.TMS_TR_STATUS,
          TMS.TMS_HUB_STATUS_ID,
          SHIPPING_BI.FN_API_TIMEZONE(SHIP.SIT_SITE_ID, SHIP.SHP_DATETIME_SHIPPED_ID) AS SHIPPED_DATETIME,
          SHIPPING_BI.FN_API_TIMEZONE(SHIP.SIT_SITE_ID, SHIP.SHP_DATETIME_DELIVERED_ID) AS DELIVERED_DATETIME,
          SHIPPING_BI.FN_API_TIMEZONE(SHIP.SIT_SITE_ID, SHIP.SHP_DATETIME_NOT_DELIVERED) AS  NOT_DELIVERED_DATETIME,
          SHIPPING_BI.FN_API_TIMEZONE(SHIP.SIT_SITE_ID, SHIP.SHP_DATETIME_CANCELLED_ID) AS CANCELLED_DATETIME,
          SHIPPING_BI.FN_API_TIMEZONE(SHIP.SIT_SITE_ID, SHIP.SHP_DATE_RETURNED) AS SHP_RETURNED_DATETIME,
          SHP_ORDER_COST_USD,--SHIP.SHP_ORDER_COST_USD,
          SER.SHP_CARRIER_ID_AJUS AS LAST_MILE_CARRIER_NAME,
          TMS.SHP_INB_CARRIER_NAME AS FIRST_MILE_CARRIER_NAME
      FROM WHOWNER.BT_SHP_SHIPMENTS AS SHIP
        LEFT JOIN WHOWNER.BT_TMS_TRACKING AS TMS 
          ON SHIP.SHP_SHIPMENT_ID = TMS.SHP_SHIPMENT_ID
        JOIN WHOWNER.LK_SHP_SHIPPING_SERVICES AS SER 
         ON SHIP.SHP_SERVICE_ID = SER.SHP_SERVICE_ID
      WHERE SHIP.SHP_TYPE = 'forward'
          AND  SHIP.SHP_SHIPPING_MODE_ID = 'me2'
          AND  SHIP.SHP_STATUS_ID IN ('not_delivered')
          AND  SHIP.SHP_PICKING_TYPE_ID IN ('cross_docking', 'xd_drop_off', 'fulfillment', 'drop_off')
          )
          SELECT * FROM SUBQ_1 WHERE CAST(SUBQ_1.DELIVERED_DATETIME AS DATE) BETWEEN P_BEGIN_DATE AND P_END_DATE
          UNION ALL 
          SELECT * FROM SUBQ_2 WHERE CAST(SUBQ_2.NOT_DELIVERED_DATETIME AS DATE) BETWEEN P_BEGIN_DATE AND P_END_DATE
  );

  CREATE OR REPLACE TABLE SHIPPING_BI.STAGE_SHIP_NO_EFECTIVAS 
  AS (
      SELECT 
          SHIP.SHP_SHIPMENT_ID,
          SHIP.SIT_SITE_ID,
          SHIP.FACILITY_ID,        
          SHIP.SHP_PICKING_TYPE_ID,
          SHIP.SHP_STATUS_ID,
          SHIP.SHP_SUBSTATUS_ID,
          SHIP.TMS_TR_STATUS,
          SHIP.TMS_HUB_STATUS_ID,
          SHIPPING_BI.FN_API_TIMEZONE(SHIP.SIT_SITE_ID, DEV.TMS_DEV_LBL_PRINT_DATE) AS TMS_DEV_LABELING_DATETIME,
          DEV.TMS_DEV_INB_STATUS,
          SHIPPING_BI.FN_API_TIMEZONE(SHIP.SIT_SITE_ID, DEV.TMS_DEV_INB_INCLUDED_AT) AS TMS_DEV_INB_INCLUDED_DATETIME,
          SHIPPING_BI.FN_API_TIMEZONE(SHIP.SIT_SITE_ID, DEV.TMS_DEV_INB_DATE_CLOSED) AS TMS_DEV_INB_FINISH_DATETIME,        
          DEV.TMS_DEV_OUT_STATUS,
          SHIPPING_BI.FN_API_TIMEZONE(SHIP.SIT_SITE_ID, DEV.TMS_DEV_OUT_DATE_OPENED) AS TMS_DEV_OUT_START_DATETIME,
          SHIPPING_BI.FN_API_TIMEZONE(SHIP.SIT_SITE_ID, DEV.TMS_DEV_OUT_DATE_CLOSED) AS TMS_DEV_OUT_FINISH_DATETIME,
          DEV.TMS_DEV_DISPATCH_STATUS,
          SHIPPING_BI.FN_API_TIMEZONE(SHIP.SIT_SITE_ID, DEV.TMS_DEV_DISPATCH_INCLUDED_AT) AS TMS_DEV_DISPATCH_DATETIME,
          SHIP.SHIPPED_DATETIME,
          SHIP.DELIVERED_DATETIME,
          SHIP.NOT_DELIVERED_DATETIME,
          SHIP.CANCELLED_DATETIME,
          SHIP.SHP_RETURNED_DATETIME,
          CAST(NULL AS DATETIME) AS RETURNING_TO_SENDER_DATETIME,
          CAST(NULL AS DATETIME) AS RETURNED_TO_HUB_DATETIME,
          CAST(NULL AS DATETIME) AS RETURNED_DATETIME,
          CAST(NULL AS DATETIME) AS PICKED_UP_FOR_RETURN_DATETIME,
          CAST(NULL AS DATETIME) AS RETURNING_TO_WAREHOUSE_DATETIME,
          CAST(NULL AS DATETIME) AS RETURNED_TO_WAREHOUSE_DATETIME,
          CAST(NULL AS DATETIME) AS RETURN_FAILED_DATETIME,
          SHP_ORDER_COST_USD, --SHIP.SHP_ORDER_COST_USD,
          SHIP.LAST_MILE_CARRIER_NAME,
          SHIP.FIRST_MILE_CARRIER_NAME,
          CAST(NULL AS STRING) AS LAST_TRACKING_CODE,
          CAST(NULL AS STRING) AS SHP_ORIGIN,
          CAST(NULL AS INT64) AS DEL_AFTER_NOT_DEL
      FROM TMP_STAGE_SHIPMENTS_NE AS SHIP
        LEFT JOIN WHOWNER.BT_TMS_DEVOLUTIONS AS DEV
          ON SHIP.SHP_SHIPMENT_ID = DEV.SHP_SHIPMENT_ID
      WHERE SHIP.SHP_STATUS_ID = 'not_delivered'
      );

    CREATE OR REPLACE TABLE SHIPPING_BI.STAGE_CHECKPOINTS_NO_EFECTIVA AS (
      SELECT 
          SHP_SHIPMENT_ID AS SHP_SHIPMENT_ID,
          MAX(SHP_CHECKPOINT_ID) AS MAX_SHP_CHECKPOINT_ID,
          MIN(CASE WHEN SHP_SUB_STATUS = 'returning_to_sender' THEN CAST(SHP_CHECKPOINT_DATE AS DATETIME) END) AS RETURNING_TO_SENDER_DATETIME,
          MIN(CASE WHEN SHP_SUB_STATUS = 'returned_to_hub' THEN CAST(SHP_CHECKPOINT_DATE AS DATETIME) END) AS RETURNED_TO_HUB_DATETIME,
          MIN(CASE WHEN SHP_SUB_STATUS = 'returned' THEN CAST(SHP_CHECKPOINT_DATE AS DATETIME) END) AS RETURNED_DATETIME,
          MIN(CASE WHEN SHP_SUB_STATUS = 'picked_up_for_return' THEN CAST(SHP_CHECKPOINT_DATE AS DATETIME) END) AS PICKED_UP_FOR_RETURN_DATETIME,
          MIN(CASE WHEN SHP_SUB_STATUS = 'returning_to_warehouse' THEN CAST(SHP_CHECKPOINT_DATE AS DATETIME) END) AS RETURNING_TO_WAREHOUSE_DATETIME,
          MIN(CASE WHEN SHP_SUB_STATUS = 'returned_to_warehouse' THEN CAST(SHP_CHECKPOINT_DATE AS DATETIME) END) AS RETURNED_TO_WAREHOUSE_DATETIME,
          MIN(CASE WHEN SHP_SUB_STATUS = 'return_failed' THEN CAST(SHP_CHECKPOINT_DATE AS DATETIME) END) AS RETURN_FAILED_DATETIME,
          CAST(NULL AS STRING) AS LAST_TRACKING_CODE,
          CAST(NULL AS STRING) AS LAST_SHP_ORIGIN,
          MAX(CASE WHEN SHP_TRACKING_CODE = '0401' THEN 1 ELSE 0 END) AS DEL_AFTER_NOT_DEL 
      FROM WHOWNER.BT_SHP_ELASTICSEARCH_CHECKPOINTS AS E
          WHERE SHP_SHIPMENT_ID IN (SELECT SHP_SHIPMENT_ID FROM SHIPPING_BI.STAGE_SHIP_NO_EFECTIVAS)
            AND SHP_STATUS = 'not_delivered'
       GROUP BY SHP_SHIPMENT_ID
    );

    UPDATE SHIPPING_BI.STAGE_CHECKPOINTS_NO_EFECTIVA AS A
    SET
      LAST_TRACKING_CODE = B.SHP_TRACKING_CODE,
      LAST_SHP_ORIGIN = B.LAST_SHP_ORIGIN
    FROM (
      SELECT SHP_TRACKING_CODE, SHP_ORIGIN AS LAST_SHP_ORIGIN, SHP_SHIPMENT_ID AS SHP_SHIPMENT_ID
      FROM WHOWNER.BT_SHP_ELASTICSEARCH_CHECKPOINTS C
      WHERE EXISTS(SELECT 1 FROM SHIPPING_BI.STAGE_CHECKPOINTS_NO_EFECTIVA N WHERE N.MAX_SHP_CHECKPOINT_ID = C.SHP_CHECKPOINT_ID)
      qualify  ROW_NUMBER() OVER(PARTITION BY SHP_SHIPMENT_ID ORDER BY SHP_CHECKPOINT_DT DESC) = 1 
    ) AS B
    WHERE A.SHP_SHIPMENT_ID = B.SHP_SHIPMENT_ID;

    UPDATE SHIPPING_BI.STAGE_SHIP_NO_EFECTIVAS AS A
    SET
      SHP_SHIPMENT_ID = B.SHP_SHIPMENT_ID,
      RETURNING_TO_SENDER_DATETIME = SHIPPING_BI.FN_API_TIMEZONE(A.SIT_SITE_ID, B.RETURNING_TO_SENDER_DATETIME),
      RETURNED_TO_HUB_DATETIME = SHIPPING_BI.FN_API_TIMEZONE(A.SIT_SITE_ID, B.RETURNED_TO_HUB_DATETIME),
      RETURNED_DATETIME = SHIPPING_BI.FN_API_TIMEZONE(A.SIT_SITE_ID, B.RETURNED_DATETIME),
      PICKED_UP_FOR_RETURN_DATETIME = SHIPPING_BI.FN_API_TIMEZONE(A.SIT_SITE_ID, B.PICKED_UP_FOR_RETURN_DATETIME),
      RETURNING_TO_WAREHOUSE_DATETIME = SHIPPING_BI.FN_API_TIMEZONE(A.SIT_SITE_ID, B.RETURNING_TO_WAREHOUSE_DATETIME),
      RETURNED_TO_WAREHOUSE_DATETIME = SHIPPING_BI.FN_API_TIMEZONE(A.SIT_SITE_ID, B.RETURNED_TO_WAREHOUSE_DATETIME),
      RETURN_FAILED_DATETIME = SHIPPING_BI.FN_API_TIMEZONE(A.SIT_SITE_ID, B.RETURN_FAILED_DATETIME),
      LAST_TRACKING_CODE = B.LAST_TRACKING_CODE,
      SHP_ORIGIN = B.LAST_SHP_ORIGIN,
      DEL_AFTER_NOT_DEL = COALESCE(B.DEL_AFTER_NOT_DEL,0)
    FROM (
      SELECT
      SHP_SHIPMENT_ID,
      RETURNING_TO_SENDER_DATETIME,
      RETURNED_TO_HUB_DATETIME,
      RETURNED_DATETIME,
      PICKED_UP_FOR_RETURN_DATETIME,
      RETURNING_TO_WAREHOUSE_DATETIME,
      RETURNED_TO_WAREHOUSE_DATETIME,
      RETURN_FAILED_DATETIME,
      LAST_TRACKING_CODE,
      LAST_SHP_ORIGIN,
      DEL_AFTER_NOT_DEL
      FROM SHIPPING_BI.STAGE_CHECKPOINTS_NO_EFECTIVA
    ) AS B
    WHERE A.SHP_SHIPMENT_ID = B.SHP_SHIPMENT_ID;

    DELETE FROM SHIPPING_BI.SHPBI_ENTREGAS_NO_EFECTIVAS S
    WHERE EXISTS (SELECT 1 FROM SHIPPING_BI.STAGE_SHIP_NO_EFECTIVAS N WHERE N.SHP_SHIPMENT_ID = S.SHP_SHIPMENT_ID);

    INSERT INTO SHIPPING_BI.SHPBI_ENTREGAS_NO_EFECTIVAS
    (SHP_SHIPMENT_ID, SIT_SITE_ID, FACILITY_ID, SHP_PICKING_TYPE_ID, SHP_STATUS_ID, SHP_SUBSTATUS_ID, TMS_TR_STATUS, TMS_HUB_STATUS_ID,
     TMS_DEV_INB_STATUS, TMS_DEV_INB_INCLUDED_DATETIME, TMS_DEV_LABELING_DATETIME, TMS_DEV_INB_FINISH_DATETIME, TMS_DEV_OUT_STATUS, 
     TMS_DEV_OUT_START_DATETIME, TMS_DEV_OUT_FINISH_DATETIME, TMS_DEV_DISPATCH_STATUS, TMS_DEV_DISPATCH_DATETIME, 
     SHIPPED_DATETIME,DELIVERED_DATETIME, NOT_DELIVERED_DATETIME, CANCELLED_DATETIME, SHP_RETURNED_DATETIME, 
     RETURNED_TO_HUB_DATETIME, PICKED_UP_FOR_RETURN_DATETIME,RETURNING_TO_SENDER_DATETIME, RETURNED_DATETIME , RETURNING_TO_WAREHOUSE_DATETIME,   
     RETURNED_TO_WAREHOUSE_DATETIME, RETURN_FAILED_DATETIME,  SHP_ORDER_COST_USD, LAST_MILE_CARRIER_NAME, 
     FIRST_MILE_CARRIER_NAME, RETURNING_TO_HUB_HOURS, RETURNED_TO_HUB_HOURS, PICKED_UP_FOR_RETURN_HOURS, RETURNING_TO_SENDER_HOURS, TOTAL_RETURNED_HOURS,
     RETURNING_TO_WAREHOUSE_HOURS, RETURNED_TO_WAREHOUSE_HOURS, CHECKPOINTS_COUNT, DEL_AFTER_NOT_DEL,LAST_TRACKING_CODE,
     LEAD_TIME_HOURS,STAGE_IN_HOURS,LABELING_HOURS,PACKING_HOURS,STAGE_OUT_HOURS,RETURNING_TO_WAREHOUSE_DAYS,
     PICKED_UP_FOR_RETURN_DAYS,RETURNED_TO_HUB_DAYS,RETURNING_TO_SENDER_DAYS,TOTAL_RETURNED_DAYS,STAGE_IN_DAYS,LABELING_DAYS,PACKING_DAYS,STAGE_OUT_DAYS,LAST_SHP_ORIGIN)
     SELECT 
          SHP_SHIPMENT_ID, 
          SIT_SITE_ID, 
          FACILITY_ID, 
          SHP_PICKING_TYPE_ID, 
          SHP_STATUS_ID, 
          SHP_SUBSTATUS_ID, 
          TMS_TR_STATUS, 
          TMS_HUB_STATUS_ID, 
          TMS_DEV_INB_STATUS, 
          TMS_DEV_INB_INCLUDED_DATETIME, 
          TMS_DEV_LABELING_DATETIME,      
          TMS_DEV_INB_FINISH_DATETIME, 
          TMS_DEV_OUT_STATUS, 
          TMS_DEV_OUT_START_DATETIME, 
          TMS_DEV_OUT_FINISH_DATETIME, 
          TMS_DEV_DISPATCH_STATUS, 
          TMS_DEV_DISPATCH_DATETIME, 
          SHIPPED_DATETIME, 
          DELIVERED_DATETIME,
          NOT_DELIVERED_DATETIME, 
          CANCELLED_DATETIME, 
          SHP_RETURNED_DATETIME, 
          RETURNED_TO_HUB_DATETIME, --XD
          PICKED_UP_FOR_RETURN_DATETIME,--XD
          RETURNING_TO_SENDER_DATETIME, --XD
          RETURNED_DATETIME, --XD
          RETURNING_TO_WAREHOUSE_DATETIME, --FBM
          RETURNED_TO_WAREHOUSE_DATETIME, --FBM
          RETURN_FAILED_DATETIME, 
          SHP_ORDER_COST_USD, 
          LAST_MILE_CARRIER_NAME, 
          FIRST_MILE_CARRIER_NAME, 
          NULL AS RETURNING_TO_HUB_HOURS, -- VER SI PODEMOS CALCULARLO
          SHIPPING_BI.FN_UTIL_DIFF_TIMES_TO_HOURS(RETURNING_TO_SENDER_DATETIME,RETURNED_TO_HUB_DATETIME) AS  RETURNED_TO_HUB_HOURS, 
          SHIPPING_BI.FN_UTIL_DIFF_TIMES_TO_HOURS(RETURNED_TO_HUB_DATETIME,PICKED_UP_FOR_RETURN_DATETIME) AS  PICKED_UP_FOR_RETURN_HOURS, 
          SHIPPING_BI.FN_UTIL_DIFF_TIMES_TO_HOURS(PICKED_UP_FOR_RETURN_DATETIME,RETURNED_DATETIME) AS  RETURNING_TO_SENDER_HOURS, 
          SHIPPING_BI.FN_UTIL_DIFF_TIMES_TO_HOURS(RETURNING_TO_SENDER_DATETIME,RETURNED_DATETIME) AS TOTAL_RETURNED_HOURS,
          SHIPPING_BI.FN_UTIL_DIFF_TIMES_TO_HOURS(RETURNING_TO_WAREHOUSE_DATETIME,RETURNED_TO_WAREHOUSE_DATETIME) AS  RETURNING_TO_WAREHOUSE_HOURS, 
          NULL AS RETURNED_TO_WAREHOUSE_HOURS, --VER SI TIENE SENTIDO
          CASE WHEN RETURNED_TO_HUB_DATETIME IS NULL THEN 0 ELSE 1 END + 
            CASE WHEN PICKED_UP_FOR_RETURN_DATETIME IS NULL THEN 0 ELSE 1 END + 
            CASE WHEN RETURNING_TO_SENDER_DATETIME IS NULL THEN 0 ELSE 1 END + 
            CASE WHEN RETURNED_DATETIME IS NULL THEN 0 ELSE 1 END + 
            CASE WHEN RETURNING_TO_WAREHOUSE_DATETIME IS NULL THEN 0 ELSE 1 END + 
            CASE WHEN RETURNED_TO_WAREHOUSE_DATETIME IS NULL THEN 0 ELSE 1 END 
           AS CHECKPOINTS_COUNT,
          --CASE WHEN LAST_TRACKING_CODE ='0401' THEN 1 ELSE 0 END AS DEL_AFTER_NOT_DEL,
          DEL_AFTER_NOT_DEL,
          LAST_TRACKING_CODE,
          SHIPPING_BI.FN_UTIL_DIFF_TIMES_TO_HOURS(NOT_DELIVERED_DATETIME, COALESCE(RETURNED_DATETIME,RETURNED_TO_WAREHOUSE_DATETIME)) AS LEAD_TIME_HOURS ,
          SHIPPING_BI.FN_UTIL_DIFF_TIMES_TO_HOURS(TMS_DEV_INB_INCLUDED_DATETIME,TMS_DEV_LABELING_DATETIME) AS STAGE_IN_HOURS,
          SHIPPING_BI.FN_UTIL_DIFF_TIMES_TO_HOURS(TMS_DEV_LABELING_DATETIME,TMS_DEV_OUT_START_DATETIME) AS LABELING_HOURS,
          SHIPPING_BI.FN_UTIL_DIFF_TIMES_TO_HOURS(TMS_DEV_OUT_START_DATETIME,TMS_DEV_OUT_FINISH_DATETIME) AS PACKING_HOURS,
          SHIPPING_BI.FN_UTIL_DIFF_TIMES_TO_HOURS(TMS_DEV_OUT_FINISH_DATETIME,TMS_DEV_DISPATCH_DATETIME) AS STAGE_OUT_HOURS,
          ROUND(CAST(SHIPPING_BI.FN_UTIL_DIFF_TIMES_TO_HOURS(RETURNING_TO_WAREHOUSE_DATETIME,RETURNED_TO_WAREHOUSE_DATETIME) /24 AS NUMERIC), 2) AS RETURNING_TO_WAREHOUSE_DAYS,
          ROUND(CAST(SHIPPING_BI.FN_UTIL_DIFF_TIMES_TO_HOURS(RETURNING_TO_SENDER_DATETIME,RETURNED_TO_HUB_DATETIME) /24 AS NUMERIC), 2) AS RETURNED_TO_HUB_DAYS,
          ROUND(CAST(SHIPPING_BI.FN_UTIL_DIFF_TIMES_TO_HOURS(RETURNED_TO_HUB_DATETIME,PICKED_UP_FOR_RETURN_DATETIME) /24 AS NUMERIC), 2) AS PICKED_UP_FOR_RETURN_DAYS,
          ROUND(CAST(SHIPPING_BI.FN_UTIL_DIFF_TIMES_TO_HOURS(PICKED_UP_FOR_RETURN_DATETIME,RETURNED_DATETIME) /24 AS NUMERIC), 2) AS RETURNING_TO_SENDER_DAYS,
          ROUND(CAST(SHIPPING_BI.FN_UTIL_DIFF_TIMES_TO_HOURS(RETURNING_TO_SENDER_DATETIME,RETURNED_DATETIME) /24 AS NUMERIC), 2) AS TOTAL_RETURNED_DAYS,
          ROUND(CAST(SHIPPING_BI.FN_UTIL_DIFF_TIMES_TO_HOURS(TMS_DEV_INB_INCLUDED_DATETIME,TMS_DEV_LABELING_DATETIME) / 24 AS NUMERIC), 2) AS STAGE_IN_DAYS,
          ROUND(CAST(SHIPPING_BI.FN_UTIL_DIFF_TIMES_TO_HOURS(TMS_DEV_LABELING_DATETIME,TMS_DEV_OUT_START_DATETIME) / 24 AS NUMERIC), 2) AS LABELING_DAYS,
          ROUND(CAST(SHIPPING_BI.FN_UTIL_DIFF_TIMES_TO_HOURS(TMS_DEV_OUT_START_DATETIME,TMS_DEV_OUT_FINISH_DATETIME) / 24 AS NUMERIC), 2) AS PACKING_DAYS,
          ROUND(CAST(SHIPPING_BI.FN_UTIL_DIFF_TIMES_TO_HOURS(TMS_DEV_OUT_FINISH_DATETIME,TMS_DEV_DISPATCH_DATETIME) / 24 AS NUMERIC), 2) AS STAGE_OUT_DAYS,
          SHP_ORIGIN AS LAST_SHP_ORIGIN
      FROM SHIPPING_BI.STAGE_SHIP_NO_EFECTIVAS;

      DELETE FROM SHIPPING_BI.SHPBI_ENTREGAS_NO_EFECTIVAS_AGRUP 
      WHERE NOT_DELIVERED_DATE < DATE_ADD(CURRENT_DATE(), INTERVAL -13 MONTH);   

      DELETE FROM SHIPPING_BI.SHPBI_ENTREGAS_NO_EFECTIVAS_AGRUP
      WHERE NOT_DELIVERED_DATE >= P_BEGIN_DATE;

      INSERT INTO SHIPPING_BI.SHPBI_ENTREGAS_NO_EFECTIVAS_AGRUP
      ( 
        KPI_GROUP,
        SIT_SITE_ID,
        FACILITY_ID,
        SHP_PICKING_TYPE_ID,
        SHP_STATUS_ID,
        SHP_SUBSTATUS_ID,
        TMS_HUB_STATUS_ID,
        TMS_DEV_DISPATCH_STATUS,
        TMS_DEV_DISPATCH_DATE,
        SHIPPED_DATE,
        NOT_DELIVERED_DATE,
        RETURNED_DATE,
        RETURNED_TO_WAREHOUSE_DATE,
        GMV_NOT_DELIVERED,
        LAST_MILE_CARRIER_NAME,
        DEL_AFTER_NOT_DEL,
        LAST_TRACKING_CODE  ,     
        SHIPMENTS_NOT_DELIVERED,
        RETURNED_TO_HUB_HOURS,
        RETURNED_TO_HUB_SHIPMENTS,
        PICKED_UP_FOR_RETURN_HOURS,
        PICKED_UP_FOR_RETURN_SHIPMENTS,
        RETURNING_TO_SENDER_HOURS,
        RETURNING_TO_SENDER_SHIPMENTS,
        TOTAL_RETURNED_HOURS,
        TOTAL_RETURNED_SHIPMENTS,
        RETURNING_TO_WAREHOUSE_HOURS,
        RETURNING_TO_WAREHOUSE_SHIPMENTS,
        CHECKPOINTS_COUNT,
        LEAD_TIME_HOURS,
        LEAD_TIME_SHIPMENTS,
        STAGE_IN_HOURS,
        STAGE_IN_SHIPMENTS,
        LABELING_HOURS,
        LABELING_SHIPMENTS,
        PACKING_HOURS,
        PACKING_SHIPMENTS,
        STAGE_OUT_HOURS,
        STAGE_OUT_SHIPMENTS,
        RETURNING_TO_WAREHOUSE_RANGE,
        PICKED_UP_FOR_RETURN_RANGE,
        RETURNED_TO_HUB_RANGE,
        RETURNING_TO_SENDER_RANGE,
        TOTAL_RETURNED_RANGE,
        STAGE_IN_RANGE,
        LABELING_RANGE,
        PACKING_RANGE,
        STAGE_OUT_RANGE,
        LAST_SHP_ORIGIN,
        GMV_DEL_AFTER_NOT_DEL)
      SELECT 
        'NO_EFECTIVAS' AS KPI_GROUP,
        SIT_SITE_ID,
        FACILITY_ID,
        SHP_PICKING_TYPE_ID,
        SHP_STATUS_ID,
        SHP_SUBSTATUS_ID,
        TMS_HUB_STATUS_ID,
        TMS_DEV_DISPATCH_STATUS,
        CAST(TMS_DEV_DISPATCH_DATETIME AS DATE) AS TMS_DEV_DISPATCH_DATE,
        CAST(SHIPPED_DATETIME AS DATE) AS SHIPPED_DATE,
        CAST(NOT_DELIVERED_DATETIME AS DATE) AS NOT_DELIVERED_DATE,
        CAST(RETURNED_DATETIME AS DATE) AS RETURNED_DATE,
        CAST(RETURNED_TO_WAREHOUSE_DATETIME AS DATE) AS RETURNED_TO_WAREHOUSE_DATE,
        CAST(SUM(SHP_ORDER_COST_USD) AS NUMERIC) GMV_NOT_DELIVERED,
        LAST_MILE_CARRIER_NAME,
        CAST(SUM(DEL_AFTER_NOT_DEL) AS NUMERIC) DEL_AFTER_NOT_DEL,
        LAST_TRACKING_CODE,
        COUNT(SHP_SHIPMENT_ID) SHIPMENTS_NOT_DELIVERED,
        CAST(SUM(CASE WHEN RETURNED_TO_HUB_HOURS > 0 THEN RETURNED_TO_HUB_HOURS ELSE 0 END) AS NUMERIC),
        COUNT(CASE WHEN RETURNED_TO_HUB_HOURS > 0 THEN SHP_SHIPMENT_ID ELSE NULL END) AS RETURNED_TO_HUB_SHIPMENTS,
        CAST(SUM(CASE WHEN PICKED_UP_FOR_RETURN_HOURS > 0 THEN PICKED_UP_FOR_RETURN_HOURS ELSE 0 END ) AS NUMERIC),
        COUNT(CASE WHEN PICKED_UP_FOR_RETURN_HOURS > 0 THEN SHP_SHIPMENT_ID ELSE NULL END ) AS PICKED_UP_FOR_RETURN_SHIPMENTS,
        CAST(SUM(CASE WHEN RETURNING_TO_SENDER_HOURS > 0 THEN RETURNING_TO_SENDER_HOURS ELSE 0 END ) AS NUMERIC),
        COUNT(CASE WHEN RETURNING_TO_SENDER_HOURS > 0 THEN SHP_SHIPMENT_ID ELSE NULL END ) AS RETURNING_TO_SENDER_SHIPMENTS,
        CAST(SUM(CASE WHEN TOTAL_RETURNED_HOURS > 0 THEN TOTAL_RETURNED_HOURS ELSE 0 END ) AS NUMERIC),
        COUNT(CASE WHEN TOTAL_RETURNED_HOURS > 0 THEN SHP_SHIPMENT_ID ELSE NULL END ) AS RETURNING_TO_SENDER_SHIPMENTS,
        CAST(SUM(CASE WHEN RETURNING_TO_WAREHOUSE_HOURS > 0 THEN RETURNING_TO_WAREHOUSE_HOURS ELSE 0 END ) AS NUMERIC),
        COUNT(CASE WHEN RETURNING_TO_WAREHOUSE_HOURS > 0 THEN SHP_SHIPMENT_ID ELSE NULL END ) AS RETURNING_TO_WAREHOUSE_SHIPMENTS,
        CAST(CHECKPOINTS_COUNT AS NUMERIC) CHECKPOINTS_COUNT,
        CAST(SUM(CASE WHEN LEAD_TIME_HOURS > 0 THEN LEAD_TIME_HOURS ELSE 0 END ) AS NUMERIC),
        COUNT(CASE WHEN LEAD_TIME_HOURS > 0 THEN SHP_SHIPMENT_ID ELSE NULL END ) AS LEAD_TIME_SHIPMENTS,
        CAST(SUM(CASE WHEN STAGE_IN_HOURS > 0 THEN STAGE_IN_HOURS ELSE 0 END ) AS NUMERIC),
        COUNT(CASE WHEN STAGE_IN_HOURS > 0 THEN SHP_SHIPMENT_ID ELSE NULL END) AS STAGE_IN_SHIPMENTS,
        CAST(SUM(CASE WHEN LABELING_HOURS > 0 THEN LABELING_HOURS ELSE 0 END ) AS NUMERIC),
        COUNT(CASE WHEN LABELING_HOURS > 0 THEN SHP_SHIPMENT_ID ELSE NULL END) AS LABELING_SHIPMENTS,
        CAST(SUM(CASE WHEN PACKING_HOURS > 0 THEN PACKING_HOURS ELSE 0 END ) AS NUMERIC),
        COUNT(CASE WHEN PACKING_HOURS > 0  THEN SHP_SHIPMENT_ID ELSE NULL END) AS PACKING_SHIPMENTS,
        CAST(SUM(CASE WHEN STAGE_OUT_HOURS > 0 THEN STAGE_OUT_HOURS ELSE 0 END ) AS NUMERIC),
        COUNT(CASE WHEN STAGE_OUT_HOURS > 0 THEN SHP_SHIPMENT_ID ELSE NULL END) AS STAGE_OUT_SHIPMENTS,
        CASE 
          WHEN RETURNING_TO_WAREHOUSE_DAYS < 3
            THEN '< 3 Days'
          WHEN RETURNING_TO_WAREHOUSE_DAYS >= 3 AND RETURNING_TO_WAREHOUSE_DAYS < 5
            THEN '3-5 Days'
          WHEN RETURNING_TO_WAREHOUSE_DAYS >= 5 AND RETURNING_TO_WAREHOUSE_DAYS < 7
            THEN '5-7 Days' 
          WHEN RETURNING_TO_WAREHOUSE_DAYS >= 7 AND RETURNING_TO_WAREHOUSE_DAYS < 9
            THEN '7-9 Days'   
          WHEN RETURNING_TO_WAREHOUSE_DAYS >= 9
            THEN '>= 9 Days'  
          else 'Incomplete checkpoints'
        END AS RETURNING_TO_WAREHOUSE_RANGE,
        CASE 
          WHEN RETURNED_TO_HUB_DAYS < 1
            THEN '< 1 Day'
          WHEN RETURNED_TO_HUB_DAYS >= 1 AND RETURNED_TO_HUB_DAYS < 2
            THEN '1 Day'
          WHEN RETURNED_TO_HUB_DAYS >= 2 AND RETURNED_TO_HUB_DAYS < 3
            THEN '2 Days' 
          WHEN RETURNED_TO_HUB_DAYS >= 3 AND RETURNED_TO_HUB_DAYS < 4
            THEN '3 Days'   
          WHEN RETURNED_TO_HUB_DAYS >= 4
            THEN '>= 4 Days'  
          ELSE 'Incomplete checkpoints' 
        END AS RETURNED_TO_HUB_RANGE,     
        CASE 
          WHEN PICKED_UP_FOR_RETURN_DAYS < 5
            THEN '< 5 Days'
          WHEN PICKED_UP_FOR_RETURN_DAYS >= 5 AND PICKED_UP_FOR_RETURN_DAYS < 10
            THEN '5-10 Days'
          WHEN PICKED_UP_FOR_RETURN_DAYS >= 10 AND PICKED_UP_FOR_RETURN_DAYS < 15
            THEN '10-15 Days' 
          WHEN PICKED_UP_FOR_RETURN_DAYS >= 15 AND PICKED_UP_FOR_RETURN_DAYS < 20
            THEN '15-20 Days'   
          WHEN PICKED_UP_FOR_RETURN_DAYS >= 20
            THEN '>= 20 Days' 
          ELSE 'Incomplete checkpoints' 
        END AS PICKED_UP_FOR_RETURN_RANGE,      -- VA EN HS PORQUE DAN MUY BAJOS LOS VALORES.  PASAR CASOS DE CHECKPOINTS PARA REVISAR
        CASE 
          WHEN RETURNING_TO_SENDER_DAYS < 5
            THEN '< 5 Days'
          WHEN RETURNING_TO_SENDER_DAYS >= 5 AND RETURNING_TO_SENDER_DAYS < 10
            THEN '5-10 Days'
          WHEN RETURNING_TO_SENDER_DAYS >= 10 AND RETURNING_TO_SENDER_DAYS < 15
            THEN '10-15 Days' 
          WHEN RETURNING_TO_SENDER_DAYS >= 15 AND RETURNING_TO_SENDER_DAYS < 20
            THEN '15-20 Days'   
          WHEN RETURNING_TO_SENDER_DAYS >= 20
            THEN '>= 20 Days' 
          ELSE 'Incomplete checkpoints' 
        END AS RETURNING_TO_SENDER_RANGE,
        CASE 
          WHEN TOTAL_RETURNED_DAYS < 5
            THEN '< 5 Days'
          WHEN TOTAL_RETURNED_DAYS >= 5 AND TOTAL_RETURNED_DAYS < 10
            THEN '5-10 Days'
          WHEN TOTAL_RETURNED_DAYS >= 10 AND TOTAL_RETURNED_DAYS < 15
            THEN '10-15 Days' 
          WHEN TOTAL_RETURNED_DAYS >= 15 AND TOTAL_RETURNED_DAYS < 20
            THEN '15-20 Days'   
          WHEN TOTAL_RETURNED_DAYS >= 20
            THEN '>= 20 Days' 
          ELSE 'Incomplete checkpoints'
        END AS TOTAL_RETURNED_RANGE,
        CASE 
          WHEN STAGE_IN_HOURS < 0.2
            THEN '< 0.2 Hours'
          WHEN STAGE_IN_HOURS >= 0.2 AND STAGE_IN_HOURS < 0.4
            THEN '0.2 - 0.4 Hours'
          WHEN STAGE_IN_HOURS >= 0.4 AND STAGE_IN_HOURS < 0.6
            THEN '0.4 - 0.6 Hours'
          WHEN STAGE_IN_HOURS >= 0.6 AND STAGE_IN_HOURS < 0.8
            THEN '0.6 - 0.8 Hours'    
          WHEN STAGE_IN_HOURS >= 0.8
            THEN '>= 0.8 Hours' 
          ELSE 'Incomplete checkpoints' 
        END AS STAGE_IN_RANGE,      
        CASE 
          WHEN LABELING_HOURS < 5
            THEN '< 5 Hours'
          WHEN LABELING_HOURS >= 5 AND LABELING_HOURS < 10
            THEN '5-10 Hours'
          WHEN LABELING_HOURS >= 10 AND LABELING_HOURS < 15
            THEN '10-15 Hours'  
          WHEN LABELING_HOURS >= 15 AND LABELING_HOURS < 20
            THEN '15-20 Hours'    
          WHEN LABELING_HOURS >= 20
            THEN '>= 20 Hours'
          ELSE 'Incomplete checkpoints' 
        END AS LABELING_RANGE,      
        CASE 
          WHEN PACKING_HOURS < 0.2
            THEN '< 0.2 Hours'
          WHEN PACKING_HOURS >= 0.2 AND PACKING_HOURS < 0.4
            THEN '0.2 - 0.4 Hours'
          WHEN PACKING_HOURS >= 0.4 AND PACKING_HOURS < 0.6
            THEN '0.4 - 0.6 Hours'
          WHEN PACKING_HOURS >= 0.6 AND PACKING_HOURS < 0.8
            THEN '0.6 - 0.8 Hours'    
          WHEN PACKING_HOURS >= 0.8
            THEN '>= 0.8 Hours' 
          ELSE 'Incomplete checkpoints' 
        END AS PACKING_RANGE,     
        CASE 
          WHEN STAGE_OUT_HOURS < 5
            THEN '< 5 Hours'
          WHEN STAGE_OUT_HOURS >= 5 AND STAGE_OUT_HOURS < 10
            THEN '5-10 Hours'
          WHEN STAGE_OUT_HOURS >= 10 AND STAGE_OUT_HOURS < 15
            THEN '10-15 Hours'  
          WHEN STAGE_OUT_HOURS >= 15 AND STAGE_OUT_HOURS < 20
            THEN '15-20 Hours'    
          WHEN STAGE_OUT_HOURS >= 20
            THEN '>= 20 Hours'
          ELSE 'Incomplete checkpoints' 
        END AS STAGE_OUT_RANGE,
        LAST_SHP_ORIGIN,
        CAST(SUM(CASE WHEN DEL_AFTER_NOT_DEL = 1 THEN SHP_ORDER_COST_USD ELSE 0 END) AS NUMERIC)  AS GMV_DEL_AFTER_NOT_DEL
      FROM SHIPPING_BI.SHPBI_ENTREGAS_NO_EFECTIVAS
      WHERE  NOT_DELIVERED_DATETIME >= P_BEGIN_DATE
      GROUP BY 
        KPI_GROUP,
        SIT_SITE_ID,
        FACILITY_ID,
        SHP_PICKING_TYPE_ID,
        SHP_STATUS_ID,
        SHP_SUBSTATUS_ID,
        TMS_HUB_STATUS_ID,
        TMS_DEV_DISPATCH_STATUS,
        TMS_DEV_DISPATCH_DATE,
        SHIPPED_DATE,
        NOT_DELIVERED_DATE,
        RETURNED_DATE,
        RETURNED_TO_WAREHOUSE_DATE,
        LAST_MILE_CARRIER_NAME,
        FIRST_MILE_CARRIER_NAME,
      --  DEL_AFTER_NOT_DEL,
        LAST_TRACKING_CODE,
        CHECKPOINTS_COUNT,
        RETURNING_TO_WAREHOUSE_RANGE,
        PICKED_UP_FOR_RETURN_RANGE,
        RETURNED_TO_HUB_RANGE,
        RETURNING_TO_SENDER_RANGE,
        TOTAL_RETURNED_RANGE,
        STAGE_IN_RANGE,
        LABELING_RANGE,
        PACKING_RANGE,
        STAGE_OUT_RANGE,
        LAST_SHP_ORIGIN;

  -- METRICAS DEL SUMMARY QUE TIENEN EN CUENTA A LOS DELIVERED      
  CREATE TEMP TABLE SHPBI_SUMMARY_NOT_DELIVERED AS (
    WITH PRE_DATA AS (
        SELECT
            SHP_SHIPMENT_ID,
            LAST_MILE_CARRIER_NAME,
            SHP_STATUS_ID,
            CAST(COALESCE(NOT_DELIVERED_DATETIME,DELIVERED_DATETIME) AS DATE) AS EVENT_DATE,
            SIT_SITE_ID,
            FACILITY_ID,
            SHP_PICKING_TYPE_ID,
            SHP_ORDER_COST_USD
        FROM TMP_STAGE_SHIPMENTS_NE
    ),
    PRE_DATA_SUMMARIZED AS (
        SELECT 
            LAST_MILE_CARRIER_NAME,
            SHP_STATUS_ID,
            EVENT_DATE,
            SIT_SITE_ID,
            FACILITY_ID,
            SHP_PICKING_TYPE_ID,
            SUM(SHP_ORDER_COST_USD) AS GMV_USD,
            SUM(SUM(SHP_ORDER_COST_USD)) OVER(PARTITION BY LAST_MILE_CARRIER_NAME, EVENT_DATE,SIT_SITE_ID,FACILITY_ID,SHP_PICKING_TYPE_ID) AS TOTAL_GMV_USD,
            COUNT(CASE WHEN SHP_STATUS_ID = 'not_delivered' THEN SHP_SHIPMENT_ID ELSE NULL END) AS NOT_DELIVERED_SHIPMENTS,
            COUNT(SHP_SHIPMENT_ID) AS SHIPMENTS,
            SUM(COUNT(SHP_SHIPMENT_ID)) OVER(PARTITION BY LAST_MILE_CARRIER_NAME,EVENT_DATE,SIT_SITE_ID,FACILITY_ID,SHP_PICKING_TYPE_ID) AS TOTAL_SHIPMENTS
        FROM PRE_DATA
        GROUP BY    
          LAST_MILE_CARRIER_NAME,
          SHP_STATUS_ID,
          EVENT_DATE,
          SIT_SITE_ID,
          FACILITY_ID,
          SHP_PICKING_TYPE_ID)
        SELECT 
          EVENT_DATE,
          SIT_SITE_ID,
          FACILITY_ID,
          LAST_MILE_CARRIER_NAME,
          SHP_STATUS_ID,
          SHP_PICKING_TYPE_ID,
          GMV_USD,
          TOTAL_GMV_USD,
          NOT_DELIVERED_SHIPMENTS,
          TOTAL_SHIPMENTS
        FROM PRE_DATA_SUMMARIZED 
        WHERE SHP_STATUS_ID = 'not_delivered'
    );

     INSERT INTO SHIPPING_BI.SHPBI_ENTREGAS_NO_EFECTIVAS_AGRUP
      ( 
        KPI_GROUP,
        SIT_SITE_ID,
        FACILITY_ID,
        SHP_PICKING_TYPE_ID,
        LAST_MILE_CARRIER_NAME,     
        SHP_STATUS_ID,
        NOT_DELIVERED_DATE,
        GMV_NOT_DELIVERED,
        GMV_TOTAL,
        SHIPMENTS_NOT_DELIVERED,
        SHIPMENTS_TOTAL)
      SELECT 
          'SUMMARY' AS KPI_GROUP,
          SIT_SITE_ID,
          FACILITY_ID,
          SHP_PICKING_TYPE_ID,        
          LAST_MILE_CARRIER_NAME,
          'total' AS SHP_STATUS_ID,
          EVENT_DATE AS NOT_DELIVERED_DATE,     
          CAST(GMV_USD AS NUMERIC) AS GMV_NOT_DELIVERED,
          CAST(TOTAL_GMV_USD AS NUMERIC) AS GMV_TOTAL,
          NOT_DELIVERED_SHIPMENTS AS SHIPMENTS_NOT_DELIVERED,
          TOTAL_SHIPMENTS AS SHIPMENTS_TOTAL
      FROM SHPBI_SUMMARY_NOT_DELIVERED;
END;
