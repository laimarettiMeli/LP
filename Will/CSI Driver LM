SELECT
  sit_site_id,
  shp_lg_facility_id,
  CAST(SHP_LG_ROUTE_END_DATE AS DATE) as dateend,
  TD_week_of_year(CAST(SHP_LG_ROUTE_END_DATE AS DATE)) as Week,
  EXTRACT(month from CAST(SHP_LG_ROUTE_END_DATE AS date)) as Mês,
  shp_lg_route_id,
  shp_lg_driver_id,
  TRIM(EXTRACT (year from SHP_LG_ROUTE_END_DATE)) ||
    CASE WHEN TRIM(EXTRACT (month from SHP_LG_ROUTE_END_DATE)) > 9
      THEN ''
      ELSE '0'
    END ||  
    TRIM(EXTRACT (month from SHP_LG_ROUTE_END_DATE)) ||
    CASE WHEN  TRIM(EXTRACT (day from SHP_LG_ROUTE_END_DATE)) <16
      THEN 'Q1'
      ELSE 'Q2'
    END  AS end_time_key,
  logs.SHP_COMPANY_ID AS Carrier,
  comp.shp_company_name AS Carrier_Name,
  TRIM(SHP_LG_VEHICLE_PLATE_ID)||'.'||CAST(SHP_LG_ROUTE_END_DATE as date) as Trip_Key,
  shp_lg_route_init_date,
shp_lg_vehicle_type as Tipo_veículo,
SHP_LG_ROUTE_END_DATE,
  COUNT(logs.SHP_SHIPMENT_ID) AS qty_total,
  COUNT(CASE WHEN SHP_LG_SHIPMENT_SUB_STATUS = 'delivered' THEN logs.SHP_SHIPMENT_ID END) AS Delivered,
  COUNT(CASE WHEN SHP_LG_SHIPMENT_SUB_STATUS = 'unvisited_address' THEN logs.SHP_SHIPMENT_ID END) AS Unvisited,
  COUNT(CASE WHEN SHP_LG_SHIPMENT_SUB_STATUS = 'missing' THEN logs.SHP_SHIPMENT_ID END) AS Missing,
  COUNT(CASE WHEN SHP_LG_SHIPMENT_SUB_STATUS NOT IN ('missing','unvisited_address','delivered') THEN logs.SHP_SHIPMENT_ID END) AS Other,
  COUNT(CASE WHEN SHP_LG_SHIPMENT_SUB_STATUS IS NULL THEN logs.SHP_SHIPMENT_ID END) AS stts_Null
FROM BT_SHP_LG_SHIPMENTS_ROUTES logs
INNER JOIN WHOWNER.LK_SHP_COMPANIES comp ON comp.SHP_company_ID = logs.shp_company_ID
WHERE shp_lg_route_status = 'close'
AND sit_site_id = 'MLB'
AND  shp_lg_driver_id IN ('8871')
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14
ORDER BY 1,3,5,2,6;

