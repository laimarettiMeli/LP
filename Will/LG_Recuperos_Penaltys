
DELETE FROM TEMP_45.LP_RecuperosPenaltys;

INSERT INTO TEMP_45.LP_RecuperosPenaltys
SELECT 
b.SHP_COMPANY_NAME as MLP,
b.SIT_SITE_ID,
b.SHP_LG_PRE_INVOICE_HEADER_PERIOD_NAME AS Quinzena,
b.SHP_LG_PRE_INVOICE_DETAIL_TOTAL_COST,
a.SHP_LG_PRE_INVOICE_HEADER_STEP_TYPE,
(CASE WHEN b.SHP_LG_PRE_INVOICE_DETAIL_TYPE_ID = '2' THEN 'Billing'
      WHEN b.SHP_LG_PRE_INVOICE_DETAIL_TYPE_ID = '4' THEN 'Complementary'
      ELSE 'Otros' end) as Tipo_Factura,
CAST (b.SHP_LG_PRE_INVOICE_DETAIL_LAST_UPDATED as DATE) AS LAST_UPDATED,
LEFT (b.SHP_LG_PRE_INVOICE_DETAIL_DESCRIPTION,POSITION(' ' IN b.shp_lg_pre_invoice_detail_description)) AS Status,
RIGHT (b.SHP_LG_PRE_INVOICE_DETAIL_DESCRIPTION,11) AS Shipment

from BT_SHP_LG_PRE_INVOICE_DETAIL b
join WHOWNER.BT_SHP_LG_PRE_INVOICE_HEADER a ON b.shp_lg_pre_invoice_header_pre_invoice_id = a.shp_lg_pre_invoice_header_pre_invoice_id

WHERE b.SHP_LG_PRE_INVOICE_DETAIL_TYPE_OPERATION = '-'
AND Status IN ('Stolen', 'Missing', 'Lost','Pnr')

GROUP BY 1,2,3,4,5,6,7,8,9
