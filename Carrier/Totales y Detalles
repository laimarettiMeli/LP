--Creo tabla con totales
CREATE MULTISET VOLATILE TABLE LP_Carriers_Totals AS 
(
SELECT 
   Pais--
 ,picking_type--
 ,c_carrier--
 ,date_shipped--
 ,TotalGMV--
 ,Total_Shipments--
 ,CAST((shipment_Id) AS varchar(100)) as shipment_Id
 ,CAST('1900-01-01' as DATE) as date_bpp--
 ,CAST((status) AS varchar(100)) as status--
 ,CAST((substatus) AS varchar(100)) as substatus --
 ,CAST(BPP_CASHOUT_USD as float(10)) as BPP_CASHOUT_USD
 ,CAST(GMV as float(10)) as GMV
 ,'Totals' as Source
 
FROM
(SELECT
shp.SIT_SITE_ID as Pais--
,SHP.shp_picking_type_id as picking_type--
,shp_carrier_ID_ajus as c_carrier--
,shp.shp_date_shipped_id as date_shipped--
,sum(shp.SHP_ORDER_COST_USD) TotalGMV--
,count(distinct shp.shp_shipment_id) as Total_Shipments--
,'' as shipment_Id
,'' as status
,'' as substatus
,0.00 as BPP_CASHOUT_USD
,0.00 as GMV

FROM
WHOWNER.BT_SHP_SHIPMENTS shp
LEFT OUTER JOIN WHOWNER.LK_SHP_SHIPPING_SERVICES SERV ON SERV.shp_service_id=SHP.shp_service_id
WHERE
shp.shp_date_shipped_id BETWEEN '2020-01-01' and  current_date -1
and shp.SHP_SOURCE_ID = 'MELI'
and shp.shp_shipping_mode_id = 'me2'
and shp.shp_type = 'forward'
and shp.shp_picking_type_id not in ('self_service', 'default')
and shp.shp_picking_type_id is not null
group by 1,2,3,4) a

)
WITH DATA PRIMARY INDEX (shipment_Id) ON COMMIT PRESERVE ROWS;
--Fin crear tabla totales

--Creo tabla detalles
CREATE MULTISET VOLATILE TABLE LP_Carriers_Details AS 
(
SELECT 
  Pais--
 ,picking_type--
 ,c_carrier--
 ,date_shipped--
 ,NULL as TotalGMV
 ,NULL as Total_Shipments--
 ,CAST(shipment_Id AS varchar(100)) as shipment_Id --
 ,date_bpp-- pongo asi porque no se usa el campo, en caso de querer usarlo traer solo date_bpp
 ,CAST(status AS varchar(100)) as status--
 ,CAST((substatus) AS varchar(100)) as substatus--
 ,BPP_CASHOUT_USD--
 ,GMV
 ,'Details' as Source

FROM 

(SELECT --DISTINCT 

shp.shp_shipment_id as shipment_Id,
SHP.shp_date_shipped_id as date_shipped,
SHP.shp_status_id as status,
SHP.shp_substatus_id as substatus,
SHP.shp_picking_type_id as picking_type,
SHP.sit_site_id as Pais,
serv.shp_carrier_ID_ajus as c_carrier,
shp.SHP_ORDER_COST_USD GMV,
sum((B.bpp_amt_doll) - (B.bpp_instant_recovery_amt_doll) - (B.bpp_late_recoveries_amt_doll)) AS BPP_CASHOUT_USD
,MIN(B.bpp_created_dt) as date_bpp--CAST('1900-01-01' as DATE) as date_bpp,-- 
FROM WHOWNER.BT_CM_BUYER_PROTEC_PROGRAM B
LEFT JOIN WHOWNER.BT_SHP_SHIPMENTS SHP ON SHP.shp_shipment_id=B.shp_shipment_id
LEFT OUTER JOIN WHOWNER.LK_SHP_SHIPPING_SERVICES SERV ON SERV.shp_service_id=SHP.shp_service_id

WHERE shp.shp_date_shipped_id BETWEEN '2020-01-01' AND  (current_date -1)
AND b.bpp_budget IN ('mercado_envios','mediations')
AND shp.SHP_SOURCE_ID = 'MELI'
AND shp.shp_shipping_mode_id = 'me2'
AND shp.shp_type = 'forward'
AND substatus IN ('damaged', 'lost','stolen')
and shp.shp_picking_type_id not in ('self_service', 'default')
and shp.shp_picking_type_id is not null
GROUP BY 1,2,3,4,5,6,7,8) as b
)
WITH DATA PRIMARY INDEX (shipment_Id) ON COMMIT PRESERVE ROWS;
--Fin crear tabla detalles

--Crear tabla Totals_Details
CREATE MULTISET VOLATILE TABLE LP_Carriers_Totals_Details AS 
(
SELECT *
FROM  LP_Carriers_Totals

UNION ALL
SELECT  *
FROM  LP_Carriers_Details
)
WITH DATA PRIMARY INDEX (shipment_Id) ON COMMIT PRESERVE ROWS;
--Fin crear tabla Totals_Details

--Borro Outliers
DELETE FROM LP_Carriers_Totals_Details WHERE 
picking_type in('cross_dockgin','UNKNOWN')
OR c_carrier in ('N/A')
OR (Pais='MLA' AND c_carrier='CORREIOS')
OR (Pais='MLB' AND c_carrier='OCASA')
OR (Pais='MLM' AND c_carrier='OCA')
OR (Pais='MLM' AND c_carrier='OCASA');

--Actualizo la tabla para reemplazar valores de algunas columnas

UPDATE LP_Carriers_Totals_Details
set c_carrier = OREPLACE (c_carrier, 'MOTONORTE', 'WEBPACK');
UPDATE LP_Carriers_Totals_Details
set c_carrier = OREPLACE (c_carrier, 'REPROCESOS CARRITO', 'LOGISTICS');
UPDATE LP_Carriers_Totals_Details
set c_carrier = OREPLACE (c_carrier, 'MERCADOENVIOS', 'MERCADO ENVIOS');
UPDATE LP_Carriers_Totals_Details
set substatus= OREPLACE (substatus, 'stolen0','stolen');

--Query Output

SELECT * FROM LP_Carriers_Totals_Details 
