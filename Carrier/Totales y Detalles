--DELETE FROM temp_45.LP_Carrier WHERE /*source='totals' and*/ date_shipped > '2019-12-31'--current_date -10
                                                          
                                                          --TOTALS
--DELETE last 10 days

DELETE FROM temp_45.LP_Carrier WHERE source='totals' and date_shipped BETWEEN '2020-01-01' and current_date -1;--date_shipped > current_date -10;
--INSERT TOTALS
INSERT INTO temp_45.LP_Carrier

SELECT
Pais ,picking_type ,c_carrier ,date_shipped ,TotalGMV ,Total_Shipments ,CAST((shipment_Id) AS varchar(100)) as shipment_Id ,CAST('1900-01-01' as DATE) as date_bpp ,CAST(( 
status) AS varchar(100)) as status ,CAST((substatus) AS varchar(100)) as substatus ,CAST(BPP_CASHOUT_USD as float(10)) as BPP_CASHOUT_USD ,CAST(GMV as float(10)) as GMV , 
'Totals' as Source 
FROM
(SELECT shp.SIT_SITE_ID as Pais,SHP.shp_picking_type_id as picking_type,shp_carrier_ID_ajus as c_carrier,shp.shp_date_shipped_id as date_shipped ,sum(shp.SHP_ORDER_COST_USD) TotalGMV,count(distinct shp.shp_shipment_id) as Total_Shipments,'' as shipment_Id ,'' as status ,'' as substatus ,0.00 as BPP_CASHOUT_USD ,0.00 as GMV

FROM
WHOWNER.BT_SHP_SHIPMENTS shp
LEFT OUTER JOIN WHOWNER.LK_SHP_SHIPPING_SERVICES SERV ON SERV.shp_service_id=SHP.shp_service_id

WHERE
--shp.shp_date_shipped_id BETWEEN current_date -10 and current_date -1
shp.shp_date_shipped_id BETWEEN '2020-01-01' and current_date -1
and shp.SHP_SOURCE_ID = 'MELI'
and shp.shp_shipping_mode_id = 'me2'
and shp.shp_type = 'forward'
and shp.shp_picking_type_id not in ('self_service', 'default')
and shp.shp_picking_type_id is not null
group by 1,2,3,4) a;


                                                    --DETAILS_01-> SUBSTATUS (Damaged,Lost,Stolen)
--DELETE last 60 days
DELETE FROM temp_45.LP_Carrier WHERE source='Details_1' and date_shipped BETWEEN (current_date -60) AND  (current_date -1);
--INSERT DETAILS_01
INSERT INTO temp_45.LP_Carrier
SELECT
  Pais
 ,picking_type
 ,c_carrier
 ,date_shipped
 ,NULL as TotalGMV
 ,NULL as Total_Shipments
 ,CAST(shipment_Id AS varchar(100)) as shipment_Id 
 ,date_bpp-- pongo asi porque no se usa el campo, en caso de querer usarlo traer solo date_bpp
 ,CAST(status AS varchar(100)) as status
 ,CAST((substatus) AS varchar(100)) as substatus
 ,BPP_CASHOUT_USD
 ,GMV
 ,'Details_1' as Source

FROM

(SELECT --DISTINCT
 shp.shp_shipment_id as shipment_Id, SHP.shp_date_shipped_id as date_shipped, SHP.shp_status_id as status, SHP.shp_substatus_id as substatus, SHP.shp_picking_type_id as picking_type, SHP.sit_site_id as Pais, serv.shp_carrier_ID_ajus as c_carrier, shp.SHP_ORDER_COST_USD GMV, sum((B.bpp_amt_doll) - (B.bpp_instant_recovery_amt_doll) - (B.bpp_late_recoveries_amt_doll)) AS BPP_CASHOUT_USD ,MIN(B.bpp_created_dt) as date_bpp--CAST('1900-01-01' as DATE) as date_bpp,--
FROM WHOWNER.BT_CM_BUYER_PROTEC_PROGRAM B
	LEFT JOIN WHOWNER.BT_SHP_SHIPMENTS SHP ON SHP.shp_shipment_id=B.shp_shipment_id
	LEFT OUTER JOIN WHOWNER.LK_SHP_SHIPPING_SERVICES SERV ON SERV.shp_service_id=SHP.shp_service_id

WHERE shp.shp_date_shipped_id BETWEEN (current_date -60) AND  (current_date -1)
--shp.shp_date_shipped_id BETWEEN '2020-01-01' and current_date -1
AND b.bpp_budget IN ('mercado_envios','mediations')
AND shp.SHP_SOURCE_ID = 'MELI'
AND shp.shp_shipping_mode_id = 'me2'
AND shp.shp_type = 'forward'
AND substatus IN ('damaged', 'lost','stolen')
and shp.shp_picking_type_id not in ('self_service', 'default')
and shp.shp_picking_type_id is not null
and ((B.bpp_amt_doll) - (B.bpp_instant_recovery_amt_doll) - (B.bpp_late_recoveries_amt_doll))>0
GROUP BY 1,2,3,4,5,6,7,8) as b;

                                              --DETAILS_02 -> SUBSTATUS (Claimed_me,N/A)
DELETE FROM temp_45.LP_Carrier WHERE source='Details_2' and date_shipped BETWEEN (current_date -60) AND  (current_date -1);
--INSERT DETAILS_02
INSERT INTO temp_45.LP_Carrier
SELECT
  Pais
 ,picking_type
 ,c_carrier
 ,date_shipped
 ,NULL as TotalGMV
 ,NULL as Total_Shipments
 ,CAST(shipment_Id AS varchar(100)) as shipment_Id 
 ,date_bpp-- pongo asi porque no se usa el campo, en caso de querer usarlo traer solo date_bpp
 ,CAST(status AS varchar(100)) as status
 ,CAST((substatus) AS varchar(100)) as substatus
 ,BPP_CASHOUT_USD
 ,GMV
 ,'Details_2' as Source

 FROM
 
(SELECT 

shp.shp_shipment_id as shipment_Id,
SHP.shp_date_shipped_id as date_shipped,
SHP.shp_status_id as status,
SHP.shp_picking_type_id as picking_type,
SHP.sit_site_id as Pais,
serv.shp_carrier_ID_ajus as c_carrier,
shp.SHP_ORDER_COST_USD GMV,
(CASE
      WHEN c.cla_reason_id in ('undelivered', 'automatic_claim') and eb.flag_empty_box_pf is null and shp.shp_datetime_delivered_id is not null and (shp.shp_datetime_delivered_id <= c.cla_date_claim_opened_dt) 
        THEN 'stolen' --'PNR Contradictorio'
      --WHEN  eb.flag_empty_box_pf = 1 then 'Caja Vacia'
      WHEN (c.cla_reason_id in ('defective_item') and (b.bpp_instant_recovery_amt_doll + b.bpp_late_recoveries_amt_doll + b.bpp_current_debt_amt_doll) = 0 and c.cla_sub_status not like '%benefited_both_allowed%') 
        THEN 'NO'
      WHEN (shp.shp_status_id = 'not_delivered' and shp.shp_substatus_id not in ('claimed_me')) 
        THEN 'lost'
      WHEN b.bpp_reason_id = 'shipment'
        THEN 'lost'
      WHEN B.BPP_REASON_ID = 'delayed'
        THEN 'delayed'
      ELSE 'NO' END) as substatus,
sum((B.bpp_amt_doll) - (B.bpp_instant_recovery_amt_doll) - (B.bpp_late_recoveries_amt_doll)) AS BPP_CASHOUT_USD
,MIN(B.bpp_created_dt) as date_bpp--CAST('1900-01-01' as DATE) as date_bpp,-- 

FROM WHOWNER.BT_CM_BUYER_PROTEC_PROGRAM B

    LEFT JOIN WHOWNER.BT_SHP_SHIPMENTS SHP ON SHP.shp_shipment_id=B.shp_shipment_id
    LEFT OUTER JOIN WHOWNER.LK_SHP_SHIPPING_SERVICES SERV ON SERV.shp_service_id=SHP.shp_service_id
    LEFT OUTER JOIN WHOWNER.BT_CM_CLAIMS c ON c.cla_claim_id = b.cla_claim_id and b.cla_claim_id >0
    LEFT JOIN scoring.mercado_envios_empty_box eb ON eb.ord_order_id=c.order_id

WHERE shp.shp_date_shipped_id BETWEEN (current_date -60) AND  (current_date -1)
--shp.shp_date_shipped_id BETWEEN '2020-01-01' and '2020-03-01'
--shp.shp_date_shipped_id BETWEEN '2020-03-02' and '2020-06-01'
--shp.shp_date_shipped_id BETWEEN '2020-06-02' and '2020-08-01'
--shp.shp_date_shipped_id BETWEEN '2020-08-02' and '2020-10-01'
--shp.shp_date_shipped_id BETWEEN '2020-10-02' and '2020-12-01'
--shp.shp_date_shipped_id BETWEEN '2020-12-02' and '2021-02-01'
--shp.shp_date_shipped_id BETWEEN '2021-02-02' and '2021-03-23'
AND b.bpp_budget IN ('mercado_envios','mediations')
AND shp.SHP_SOURCE_ID = 'MELI'
AND shp.shp_shipping_mode_id = 'me2'
AND shp.shp_type = 'forward'
AND shp.shp_substatus_id IN ('claimed_me','N/A')
and shp.shp_picking_type_id not in ('self_service', 'default')
and shp.shp_picking_type_id is not null
and ((B.bpp_amt_doll) - (B.bpp_instant_recovery_amt_doll) - (B.bpp_late_recoveries_amt_doll)) > 0
and substatus <> 'NO'

GROUP BY 1,2,3,4,5,6,7,8)a;

--FIN QUERY
SELECT * FROM temp_45.LP_Carrier
